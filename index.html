<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC0hHhfsxKpg22ThVOqmjrIEF-3adLCiAY",
    authDomain: "borzwearcatalog.firebaseapp.com",
    databaseURL: "https://borzwearcatalog-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "borzwearcatalog",
    storageBucket: "borzwearcatalog.appspot.com",
    messagingSenderId: "1047897032543",
    appId: "1:1047897032543:web:9599f9798ca0e56ba858ea",
    measurementId: "G-0KQPZ02Z5T"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();
</script>

<script>
  const productForm = document.getElementById('productForm');
  const catalogTableBody = document.querySelector('#catalogTable tbody');
  const filterCitySelect = document.getElementById('filterCity');
  const citySelect = document.getElementById('citySelect');
  const cityInput = document.getElementById('cityInput');
  const photosInput = document.getElementById('photos');

  const filterNameInput = document.getElementById('filterName');
  const filterMaxPriceInput = document.getElementById('filterMaxPrice');
  const filterSizeInput = document.getElementById('filterSize');

  let products = [];

  citySelect.addEventListener('change', () => {
    cityInput.value = citySelect.value;
  });

  productForm.addEventListener('submit', async e => {
    e.preventDefault();

    let city = cityInput.value.trim() || citySelect.value.trim();
    if (!city) return alert('Укажите город');
    if (!productForm.phone.value.trim()) return alert('Укажите телефон');

    const files = photosInput.files;
    if (files.length > 3) return alert('Максимум 3 фото');

    const photosURLs = [];
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const storageRef = storage.ref(`photos/${Date.now()}_${file.name}`);
      await storageRef.put(file);
      const url = await storageRef.getDownloadURL();
      photosURLs.push(url);
    }

    const newProduct = {
      name: productForm.name.value.trim(),
      price: parseFloat(productForm.price.value).toFixed(2),
      size: productForm.size.value.trim(),
      city: city,
      phone: productForm.phone.value.trim(),
      photos: photosURLs
    };

    const newRef = db.ref('products').push();
    await newRef.set(newProduct);

    productForm.reset();
    cityInput.value = '';
    citySelect.value = '';
    photosInput.value = null;
    loadProducts(); // обновляем список
  });

  function renderCatalog(filtered) {
    catalogTableBody.innerHTML = '';

    filtered.forEach(product => {
      const tr = document.createElement('tr');

      const tdPhotos = document.createElement('td');
      tdPhotos.classList.add('photos-cell');
      product.photos.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        img.alt = product.name;
        tdPhotos.appendChild(img);
      });
      tr.appendChild(tdPhotos);

      const tdName = document.createElement('td');
      tdName.textContent = product.name;
      tr.appendChild(tdName);

      const tdPrice = document.createElement('td');
      tdPrice.textContent = product.price;
      tr.appendChild(tdPrice);

      const tdSize = document.createElement('td');
      tdSize.textContent = product.size;
      tr.appendChild(tdSize);

      const tdCity = document.createElement('td');
      tdCity.textContent = product.city;
      tr.appendChild(tdCity);

      const tdContact = document.createElement('td');
      tdContact.classList.add('contact-cell');
      const aPhone = document.createElement('a');
      aPhone.href = `tel:${product.phone}`;
      aPhone.textContent = 'Позвонить';
      tdContact.appendChild(aPhone);
      tr.appendChild(tdContact);

      catalogTableBody.appendChild(tr);
    });

    updateCityFilterOptions(filtered);
  }

  function applyFilters() {
    const name = filterNameInput.value.trim().toLowerCase();
    const maxPrice = parseFloat(filterMaxPriceInput.value);
    const size = filterSizeInput.value.trim().toLowerCase();
    const city = filterCitySelect.value.trim().toLowerCase();

    const filtered = products.filter(p => {
      if (name && !p.name.toLowerCase().includes(name)) return false;
      if (!isNaN(maxPrice) && p.price > maxPrice) return false;
      if (size && p.size.toLowerCase() !== size) return false;
      if (city && p.city.toLowerCase() !== city) return false;
      return true;
    });

    renderCatalog(filtered);
  }

  function updateCityFilterOptions(filtered) {
    const cities = [...new Set(filtered.map(p => p.city))];
    filterCitySelect.innerHTML = '<option value="" selected>Все города</option>';
    cities.forEach(city => {
      const opt = document.createElement('option');
      opt.value = city;
      opt.textContent = city;
      filterCitySelect.appendChild(opt);
    });
  }

  function loadProducts() {
    db.ref('products').once('value', snapshot => {
      const data = snapshot.val() || {};
      products = Object.values(data);
      applyFilters();
    });
  }

  filterNameInput.addEventListener('input', applyFilters);
  filterMaxPriceInput.addEventListener('input', applyFilters);
  filterSizeInput.addEventListener('input', applyFilters);
  filterCitySelect.addEventListener('change', applyFilters);

  loadProducts();
</script>
